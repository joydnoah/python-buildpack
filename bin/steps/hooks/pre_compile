#!/usr/bin/env bash

echo "Pre compile"

echo "BEFORE"
echo "$BUILD_DIR$ENV_DIR"

acceptlist_regex=${2:-''}
denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}

if [ -d "$BUILD_DIR/$ENV_DIR" ]; then
    for e in $(ls $ENV_DIR); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $ENV_DIR/$e)"
      :
    done
fi

echo "AFTER"

MY_REPO_GIT=git+https://${GITHUB_USER}:${GITHUB_PASSWORD}@github.com/OnMyRadarInc/events-connector-wrapper.git@20200825-first-configuration

echo "${GITHUB_USER}"
echo "${GITHUB_PASSWORD}"
echo "${ENV_DIR}"
echo "${MY_REPO_GIT}"

if [ -f bin/pre_compile ]; then
    echo "-----> Running pre-compile hook"
    chmod +x bin/pre_compile
    sub_env bin/pre_compile
fi